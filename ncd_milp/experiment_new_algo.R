source('new_algo.R')

run_experiments <- function(my_path){
  #' Risk model algorithm experiments
  #' 
  #' Iterates through all csv files in the path and runs risk mod
  #' @param my_path character path to folder of csv files (assumes
  #' files are stored as (x)_data.csv and (x)_weights.csv)
  #' @return results are saved as a csv file results_R.csv in the same folder
  
  # Files in path
  files <- list.files(my_path)
  results <- data.frame(data = character(), n = numeric(), p = numeric(),
                        acc = numeric(), sens = numeric(), spec = numeric(), auc = numeric(),
                        sec = numeric(), iters= numeric())
  
  
  
  # Iterate through files
  for (f in files){
    if (length(grep("_data.csv", f)) == 0) next
    
    # Print for ease
    print(paste0(my_path,f))
    # Get the current seed number
    # Get the current state of the RNG
    #.Random.seed <- seed.1000_5_1_0_3_9
    
    
    # Read in data
    df <- read.csv(paste0(my_path,f))
    X <- as.matrix(df[,-1])
    y <- as.matrix(df[,1],ncol=1)
    

    test_index <- sample(c(TRUE, FALSE), size = nrow(X), replace = TRUE, prob = c(0.2, 0.8))
    X_train <- X[!test_index,]
    y_train <- y[!test_index,]
    
    X_test <- X[test_index,]
    y_test <- y[test_index,]
    
    # Add weights file if needed
    #weights <- rep(1, nrow(X))
    #weights_file <- paste0(substr(f,1,nchar(f)-8),"_weights.csv")
    #if (file.exists(weights_file)){
    #  weights <- read.csv(weights_file)
    #  weights <- weights[[1]]
    #}
    
    # Run algorithm to get risk model
    t1 <- Sys.time()
    mod <- risk_mod_new_alg(X_train, y_train,a = -5, b = 5) # change for beta bounds
    t2 <- Sys.time()
    

    # get range of possible scores
    X_nonzero <- X[,which(mod[[1]] != 0)]
    nonzero_beta <- mod[[1]][which(mod[[1]] != 0)]
    min_pts <- rep(NA, length(nonzero_beta))
    max_pts <- rep(NA, length(nonzero_beta))
    for (i in 1:ncol(X_nonzero)) {
      temp <- nonzero_beta[i] * c(min(X_nonzero[,i]), max(X_nonzero[,i]))
      min_pts[i] <- min(temp)
      max_pts[i] <- max(temp)
    }
    
    score_range <- seq(sum(min_pts), sum(max_pts)) 
    score_range <- matrix(c(score_range,rep(NA,times=length(score_range))),ncol=2)
    # match possible score with existing score board 
    score_range[match(mod[[2]][, 1], score_range[, 1]), 2] <- mod[[2]][, 2] 
    
    # convert missing probs as a weighted average
    for (i in 1:nrow(score_range)) {
      if(is.na(score_range[i,2])) {
        non_na <- which(!is.na(score_range[,2]))
        if(score_range[i,1]==0) {
          # currently set as 0.5
          score_range[i,2] <- 0.5
        } else {
          score_range[i,2] <- abs(( (1/length(non_na)) * sum(score_range[non_na,1] * score_range[non_na,2]) ) / score_range[i,1])
        }
        
      }
    }
    score_board <- score_range
    # replace missing probabilities with
    
    # Get evaluation metrics
    time_secs <- t2 - t1
    s_test <- X_test %*% mod[[1]]
    y_pred_probs <- sapply(s_test, function(s_test) return(score_board[,2][score_board[,1]==s_test]))
    y_pred_probs <- unlist(y_pred_probs)
    
    # convert probs to be class : threshold is 0.5
    res_metrics <- get_metrics(y_test,y_pred_probs)
    
    
    # Add row to data frame
    file_row <- data.frame(data=f, n = nrow(X), p = ncol(X),
                           acc = res_metrics$acc, sens = res_metrics$sens, 
                           spec = res_metrics$spec, auc = res_metrics$auc, sec = time_secs,iters=mod[[3]]) # change for cv  
    results <- rbind(results, file_row)
    
    
  }
  write.csv(results, paste0("/Users/oscar/Documents/GitHub/Risk_Model_Research/ncd_milp/sim_newalg/", "testing_2024.2.11.csv"), row.names=FALSE)
  
}

run_experiments("/Users/oscar/Documents/GitHub/Risk_Model_Research/ncd_milp/sim_newalg/")


debug(run_experiments)
undebug(run_experiments)

debug(risk_mod_new_alg)
undebug(risk_mod_new_alg)

df <- sim_1000_9_5_10_2_9_data
X <- as.matrix(df[,-1])

y <- as.matrix(df[,1],ncol=1)

w <- risk_mod_new_alg(X,y,a=-2,b=2)



seed.1000_5_1_0_3_9 <- c(10403,48,-574857958,2097476743,-1173685091,-1205539297,-1912548635,-762514163,55848552,1614783058,2023444807,-1930031472,-2073747355
                ,-995587276,189650586,-652357094,-1661422182,984516846,-919033709,-1948947937,1744643056,1145509033,1441675715,1423313074,-1169388066,-1309590013
                ,-437727484,-2110675271,420221132,-1337986817,-587348350,-688740860,1407904676,880440977,-250783737,1022504863,-1298030737,-1798907945,-1463383984
                ,286047450,2126402965,-148978801,-325740628,1708585154,-1167155527,2119613614,-2063804812,-499988956,-1680218655,1711520710,-234858704,-557361894
                ,-9295559,770455910,209356591,-1765893318,1875336494,1939201539,280695025,316642898,-160546884,1475580833,60531351,-689016307,1121230821
                ,-109016806,2130461506,626996825,1738278403,2071429861,306718423,-1086639491,1864480802,545329810,-1162204281,4787992,539465051,-1926126302
                ,-977388365,-1088296439,-1324526327,-236227366,1306023585,236438916,-1988636955,751415581,254761001,677224139,2021524497,-1928694635,-346981917
                ,1478520747,-1315788638,182264309,-1939971954,-752012218,786228811,-1806383714,72769544,-1439769597,-424165979,-790010645,-60972863,1139264896
                ,1630854283,-975366493,-78911342,167132905,1554663556,-1847694770,1457318953,328534659,1190493399,150253621,-1950095364,-626220695,151382218
                ,-166036385,94720845,-1694079071,-1840737235,38523472,-2121152927,-1802225031,-2056297395,1200704950,1602980787,-202101171,1388797635,2075223133
                ,-426730585,-1729577834,-885714585,1078423126,-1580772898,572027107,-537603191,-1980134397,-2117106219,-1245423369,311359793,-1333085026,663729856
                ,364535953,773266383,1234048399,1558098578,-387153067,345051490,1398816670,57785276,-1219593108,-992834093,1266196852,-953919291,383289170
                ,-1582643562,410849780,781547516,1673409975,-1402417618,-824850625,-1983903286,-1072722326,-1344129984,-580815563,-975152135,126492229,-1884912702
                ,-359816537,-1793416860,-1492851406,-773780466,-1001287966,-1714357782,2022892648,42467389,-1654069312,-1093324867,1474853978,-797701588,1902550404
                ,-1275595348,1381736331,-754882055,1618698403,-363956448,225550946,-1841504581,-1089217731,-865928997,-1443278177,2106076569,734065606,-1857290137
                ,967892671,254388648,7193426,-137101040,-899751556,-946846225,-664520791,-1744856300,1002770123,-1458851781,320210827,1114547817,676414551
                ,-105840175,1815375169,-598757033,1985225470,1594270668,1186022409,355005927,1820972689,-29209428,1633832670,-1467685525,-267468503,-896289788
                ,1909113224,-752150627,-217079149,1748661820,884103313,1108429935,-1926036051,-725792182,155584584,-1785194797,-673642496,333964178,-1456979968
                ,1918642932,567149014,254332329,-211280413,866951251,-252564776,77686705,-1828575312,297294993,-163897624,-1182257955,-2125201776,1211734889
                ,-694816190,-1116993292,84253758,1876117894,-1702005530,413266242,-915632977,1009689001,535545820,1902458596,1530832838,-1270443922,332678250
                ,-1132523335,-675349849,1932452335,-970412811,-1628083948,-1179960050,-2110893814,777440456,1501843781,438950659,-1618392146,-1070584874,2036756035
                ,323533188,1082775172,327522827,-453178921,1705733534,1747115711,-547554668,1892524590,948838,705745331,-287245481,-938324001,-396944384
                ,1970568015,-942424865,-573858102,-1354834904,894952177,-1458661405,-2100731046,-471368545,-491994292,-2030870415,1390995057,-1404149081,-362062446
                ,1553566302,1622269795,-1990359060,577930713,888533350,602146095,1058998152,-1446229382,-965966790,-1794379148,-1237417085,338843311,1420468117
                ,597718326,459112596,1843830353,-1231663333,537477862,1186608994,388797288,-1973822284,-1396299349,-1327149549,2010947987,-353203860,-763376234
                ,-1303683374,-2047901385,-667953403,736682328,-1251898103,-2044779476,1676914596,-1331745211,939405629,1079126319,194962464,-1234055916,1633763650
                ,1518455379,-1960600545,-1904493446,-668955053,-540073817,877071747,409897414,-1234276656,-1411068950,1369380700,-1363070169,-664121786,-859471899
                ,-1983125259,-592189973,-373786556,-367604585,-1323885222,1640068880,-621669862,-50415351,-1722067704,1491743557,139244373,-1598316749,-875955436
                ,-1198612270,-851232084,-105132108,1028620985,165372974,-1133692101,-1269490236,1047758999,1982727231,766536824,-780783004,224127651,-2076104394
                ,-1219751890,-773780798,-240564235,1960075193,-301991218,-1336391255,1582765446,-751189892,-1237311366,-296057881,-2031152689,-523970059,1660486183
                ,1451877009,1732252334,-883471934,922525683,-1197876758,-1374409580,-1738434494,-337125990,1428538412,1779480230,-1240562216,-1814545468,10948240
                ,935089324,736637959,1484050157,-184557643,-2016593361,-1845692643,-110110836,-516962244,-1261361785,388975761,-820802194,-692868659,-1722767169
                ,-1318833378,67525275,-193364027,72509332,1072136235,1644729581,-548050156,971310963,-1857706861,-140719376,-1148494659,-1683853232,1860058856
                ,-1273262885,-139968352,-1979946635,-599305128,-575172206,230922478,1955637473,483212180,382820790,498667169,-545701232,-146170010,-1281740774
                ,-409682229,1174875927,292717961,1875950348,1877090414,-1971262281,311184507,-369689372,623618443,1652099764,-218540989,249820223,-738042102
                ,1521730643,1436635368,-1928065314,-1118683249,-429421350,756243309,376353759,1306958741,-1813584923,-1758131445,-704490832,989949346,1170645759
                ,-93696995,-17919565,-1224769285,-1393010081,-1085409466,-220124539,-1684591724,305333594,1362942285,896705870,1772933471,-967451131,592285936
                ,-2043765472,1727378035,659356437,65653749,-597956555,1657369745,351934391,-974481031,1149394943,1263393644,346742164,-125296228,-867086127
                ,-733579020,-290864294,-1978035161,-1924456572,245907983,2086322897,-1219434849,-971098589,1824884932,761044548,-765682516,299421438,-153027974
                ,1034404263,-131332184,-2094560643,-504118211,-107129415,607788379,-1752793213,-1250780519,1657499068,-47568198,-105771015,-1171838284,-1364554022
                ,155685511,-1555341390,-1524235391,-627249607,-117059759,2132728160,2029565338,222367309,1812715965,-202135303,-207245031,1124463930,1209264115
                ,191821391,1273578766,-723954882,-668691833,329757477,-1620566290,1777924438,-1242353294,-2137156336,-1731648866,2141056918,-194831775,1594476575
                ,833001391,1806375103,222001287,-1283501679,1600504407,-955402800,87621223,-760285101,269220453,831664624,837629722,1846420533,119208920
                ,1749158323,-1874000454,1334181676,1909774748,1716759025,-467387818,-1994611189,-849804758,760860287,-1176154109,1580311699,496603175,-162042039
                ,513770568,871131113,1854321324,-77254178,-1435661844,-1521415895,1033009485,-467628611,-1523495617,-1280839267,711662405,611010609,-860563253
                ,-657421748,1133731890,-428248595,252631627,-1816253552,1920059626,747323799,856588942,1933015005,-2019225774,1386235194,-1845627975,-1809685538
                ,1087756469,-1757821863,959428150,-1409476827,350458390,230082185,793154696,734826194,2095529439,-1139747309,1242589303,1639179282,193704642
                ,1507992178,637405525,90761552,-20142258,344997352,-936960381,-1769449582,-1963025155,262866050,-632212983,-1688149066,344072032,927015758
                ,507681772,1006365345
)
